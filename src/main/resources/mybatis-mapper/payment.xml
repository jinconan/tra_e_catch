<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.paymentMapper">
	<parameterMap id="pDVO" type="com.team.tra_e_catch.payment.PaymentVO">
		<parameter property="emp_no" javaType="int" mode="IN"/>
		<parameter property="dtype_no" javaType="int" mode="IN"/>
		<parameter property="title" javaType="java.lang.String" mode="IN"/>
		<parameter property="path" javaType="java.lang.String" mode="IN"/>
		<parameter property="content" javaType="java.lang.String" mode="IN"/>
		<parameter property="doc_no" javaType="int" mode="IN"/>
		<parameter property="up_date" javaType="java.lang.String" mode="IN"/>
	</parameterMap>
	<!-- <parameterMap id="pBSVO" type="com.vo.BoardSubVO">
		<parameter property="b_no" javaType="int" mode="IN"/>
		<parameter property="b_seq" javaType="int" mode="IN"/>
		<parameter property="b_img" javaType="java.lang.String" mode="IN"/>
		<parameter property="b_file" javaType="java.lang.String" mode="IN"/>
		<parameter property="b_size" javaType="double" mode="IN"/>
	</parameterMap> -->
	
	
	<resultMap id="pDVO" type="com.team.tra_e_catch.payment.PaymentVO">
		<id property="emp_no" column="emp_no" />
		<result property="dtype_no" column="dtype_no" />
		<result property="title" column="title" />
		<result property="path" column="path" />
		<result property="content" column="content" />
		<result property="doc_no" column="doc_no" />
		<result property="up_date" column="up_date" />
		<association property="bsVO" resultMap="rBSVO" /> 
	</resultMap>
	<!-- <resultMap id="rBSVO" type="com.vo.BoardSubVO">
		<id property="b_no" column="b_no" />
		<id property="b_seq" column="b_seq" />
		<result property="b_img" column="b_img" />
		<result property="b_file" column="b_file" />
	</resultMap>	 -->
 	

	
	
	 <!-- 검색 조건 -->
	<!-- <select id = "searchPaymentList" resultType="map" parameterType="map">
	select * from docs where doc_no like '%{doc_no}%' and dtype_no like '%{dtype_no}%' 
	and title like '%{title}%' and up_date like '%{up_date}%' and emp_no like '%{emp_no}%' 
	and content like '%{content}%'
	
	</select>  -->
	<!-- ==============================기안================================== -->
	<insert id="insertEpay" parameterType="map">
		<selectKey keyProperty="dtno,dno" order="BEFORE" resultType="map">
			SELECT dtype_no as "dtno", seq_doc_no.nextval as "dno"  FROM doc_type WHERE name=#{dtname}
		</selectKey>
		INSERT INTO docs(doc_no, dtype_no, title, content, emp_no, up_date)
		VALUES(#{dno}, #{dtno}, #{title}, #{content}, #{eno}, TO_CHAR(sysdate,'yyyy-mm-dd'))
	</insert> 
	 
	<insert id="insertSign" parameterType="map">
		INSERT INTO  sign (doc_no, confirm_emp_no, accept_emp_no, sign_yn) 
          VALUES(#{dno}, #{ceno}, #{aeno}, 0)		
	</insert>
	 
		<!-- 서류 리스트  -->	
 	<select id="getPaymentList" resultType="map" parameterType="map">
	SELECT *
	FROM (
	    SELECT rownum rno, dno, dname, eno, title, content, udate, path, cename, aename, sign_yn, sresult
	    FROM v_draftlist
	    <where>
	    	<if test="eno != null">
	    		eno = #{eno}
	    	</if>
	    	<if test="sign_yn != null">
	    		AND sign_yn = #{sign_yn}
	    	</if>
	    	<if test="dname != null">
	    		AND dname = #{dname}
	    	</if>
	    </where>
	    ORDER BY dno desc
	)
	<where>
		<if test="offset != null and limit != null">
			rno between #{offset}+1 and #{offset}+#{limit}
		</if>
	</where>
	</select> 
	 
	<select id="getTotalPayment" resultType="int" parameterType="map">
	SELECT count(*) FROM v_draftlist
	<where>
		<if test="eno != null">eno=#{eno}</if>
		<if test="sign_yn != null">AND sign_yn=#{sign_yn}</if>
		<if test="dname != null">AND dname = #{dname}</if>
	</where>
	</select> 
	 
	<!-- ======================================================================== --> 
	<select id="getEpayWaitList" parameterType="map" resultType="map">
	SELECT *
       FROM(
    SELECT rownum rno, confirm_emp_no, accept_emp_no,  sign_yn, confirm_date, accept_date, e.emp_no,e.name ename, dt.name dtname, content, up_date, title
    FROM (
        SELECT confirm_emp_no, accept_emp_no, doc_no, sign_yn, confirm_date, accept_date 
            FROM sign
        WHERE confirm_emp_no = #{emp_no} OR accept_emp_no= #{emp_no}) sign, docs, employee e, doc_type dt
    WHERE sign.doc_no=docs.doc_no
        AND e.emp_no = docs.emp_no
        and docs.dtype_no = dt.dtype_no
    ORDER BY sign.doc_no desc
)
	</select>
	 
</mapper>