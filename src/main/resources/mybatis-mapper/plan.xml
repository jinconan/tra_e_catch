<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis-mapper.planMapper">

	<!-- 특정 조건에 대한 프로젝트 리스트를 구함. -->
	<select id="getProjList" resultType="map" parameterType="map">
		SELECT *
		FROM(
		    SELECT rownum rno
		    ,proj_no as "proj_no"
		    ,pstatus_no as "pstatus_no"
		    , pstatus_name as "pstatus_name"
		    , proj_name as "proj_name"
		    , emp_name as "emp_name"
		    , start_date as "start_date"
		    , end_sched_date as "end_sched_date"
		    , end_date  as "end_date"
		    FROM v_getprojlist 
			<where>
				<choose>
					<when test="pstatus_name!=null and pstatus_name.equals('진행중')">
						AND pstatus_no = 1
					</when>
					<when test="pstatus_name!=null and pstatus_name.equals('종료')">
						AND pstatus_no = 2
					</when>
					<when test="pstatus_name!=null and pstatus_name.equals('중단')">
						AND pstatus_no = 3
					</when>
					<otherwise></otherwise>
				</choose>
				<choose>
					<when
						test="searchColumn != null and searchColumn.equals('project_name')">
						AND proj_name LIKE '%' || #{searchValue} || '%'
					</when>
					<when
						test="searchColumn != null and searchColumn.equals('leader_name')">
						AND emp_name LIKE '%' || #{searchValue} || '%'
					</when>
					<otherwise></otherwise>
				</choose>
			</where>
			)
			WHERE rno BETWEEN (#{pageNo}-1)*10+1 AND #{pageNo}*10
	</select>

	<!-- 특정 조건에 대해서 조회된 프로젝트 리스트의 총 페이지 개수를 구함. -->
	<select id="getNumOfProjPage" resultType="int" parameterType="map">
		SELECT CEIL(count(*)/10)
		FROM v_getprojlist
		<where>
			<choose>
				<when test="pstatus_name!=null and pstatus_name.equals('진행중')">
					AND pstatus_no = 1
				</when>
				<when test="pstatus_name!=null and pstatus_name.equals('종료')">
					AND pstatus_no = 2
				</when>
				<when test="pstatus_name!=null and pstatus_name.equals('중단')">
					AND pstatus_no = 3
				</when>
				<otherwise></otherwise>
			</choose>
			<choose>
				<when
					test="searchColumn != null and searchColumn.equals('project_name')">
					AND proj_name LIKE '%' || #{searchValue} || '%'
				</when>
				<when
					test="searchColumn != null and searchColumn.equals('leader_name')">
					AND emp_name LIKE '%' || #{searchValue} || '%'
				</when>
				<otherwise></otherwise>
			</choose>
		</where>
	</select>
	
	<!-- 프로젝트 번호로 해당 프로젝트 조회 -->
	<select id="getProjDetail" parameterType="int" resultType="map">
		SELECT proj_no as "proj_no" 
	        ,name as "proj_name"
	        ,DECODE(pstatus_no,1,'진행중',2,'종료',3,'중단') as "pstatus_name"
	        ,start_date as "start_date"
	        ,end_sched_date as "end_sched_date"
	        ,end_date as "end_date"
	        ,first_pay as "first_pay"
	    FROM project
	    WHERE proj_no = #{proj_no}
	</select>
	
	<!-- 일정 리턴. 원할시 당일 일정 조회가능. -->
	<select id="getProjTimeline" parameterType="map" resultType="map">
	SELECT project.proj_no as "proj_no" 
	    ,sched_no as "sched_no"
	    ,schedule.name as "sched_name"
	    ,project.name as "proj_name"
	    ,schedule.start_date as "start_date"
	    ,SCHEDULE.END_DATE as "end_date"
	FROM schedule,project
	WHERE schedule.proj_no = project.proj_no
	<if test="proj_no != null">
		AND project.proj_no = #{proj_no}
	</if>
	<if test="isToday">
		AND sysdate BETWEEN TO_DATE(schedule.start_date,'YYYY-MM-DD') AND TO_DATE(schedule.end_date,'YYYY-MM-DD')
	</if>
	</select>
	
	<!-- 프로젝트 일정 리스트 JSOn으로 사용하기위한 단순한 버전 -->
	<select id="getJsonProjTimeline" parameterType="map" resultType="map">
	SELECT schedule.name as "sched_name"
	    ,schedule.start_date as "start_date"
	    ,SCHEDULE.END_DATE as "end_date"
	FROM schedule,project
	WHERE schedule.proj_no = project.proj_no
	<if test="proj_no != null">
		AND project.proj_no = #{proj_no}
	</if>
	<if test="isToday == true">
		AND sysdate BETWEEN TO_DATE(schedule.start_date,'YYYY-MM-DD') AND TO_DATE(schedule.end_date,'YYYY-MM-DD')
	</if>	
	</select>
	
	<insert id="insertProj" parameterType="map">
	INSERT INTO project(proj_no, name, start_date, end_sched_date, pstatus_no)
		VALUES(5000, #{proj_name}, #{start_date},#{end_sched_date},1)
	</insert>
	
	<delete id="deleteProj" parameterType="int">
	DELETE FROM project WHERE proj_no = #{1}
	</delete>
</mapper>